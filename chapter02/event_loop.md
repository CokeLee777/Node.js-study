## 이벤트 루프

다음과 같은 비동기 코드가 실행된다고 가정해보자.

```javascript
function run(){
    console.log("3초 후 실행");
}
console.log("시작");
setTimeout(run, 3000);
console.log("끝");
```

이 코드의 실행 순서는 다음과 같이 실행된다.

1. 호출 스택에 `Anonymous`가 하나 쌓인다.
2. 호출 스택에 `console.log("시작")`이 쌓이고, 이 함수가 실행되면서 콘솔창에 '시작'이 뜨고 호출 스택에서 빠져나간다.
3. 호출 스택에 `setTimeout(run, 3000)`이 쌓이고, 이 함수는 비동기 함수이기 때문에 **백그라운드**에 '3초뒤에 run함수를 실행'을 넣어두고 호출 스택에서 빠져나간다.
4. 호출 스택에 `console.log("끝")`이 쌓이고, 이 함수가 실행되면서 콘솔창에 '끝'이 뜨고 호출 스택에서 빠져나간다.
5. 더 이상 호출 스택에 들어와 실행할 것이 없으므로, `Anonymous`도 호출 스택에서 빠져나간다.
6. 호출 스택이 비었으면 그제서야 백그라운드에 있는 `run함수`는 3초뒤에 테스크 큐로 넘어간다.
7. 호출 스택이 비어있는 것을 확인하면 테스크 큐에 있는 `run함수`는 호출 스택으로 넘어간다.
8. `run함수` 내부에 있는 `console.log("3초 후 실행")`이 호출스택에 쌓이고, 이 함수가 실행되면서 콘솔창에 '3초 후 실행'이 뜨고 호출 스택에서 빠져나간다.
9. `run함수`도 끝이나면 호출 스택에서 빠져나간다.

> 이러한 과정의 루프를 이벤트 루프라고 한다.

이 때 백그라운드 스레드의 특징은 다음과 같다.
- 특정 코드만 백그라운드로 보낼 수 있다.
- 백그라운드의 작업들은 동시에 동작한다.

또 한가지 복잡한 예시를 가정해보자.

```javascript
function oneMore(){
    console.log("one More");
}
function run(){
    console.log("run run");
    setTimeout(() => {
        console.log("wow");
    }, 0);
    new Promise((resolve) => {
        resolve("hi");
    })
    .then(console.log)
    
    oneMore();
}

setTimeout(run, 5000);
```

이 코드의 실행 순서는 다음과 같다.

1. 호출 스택에 Anonymous가 하나 쌓인다.
2. 호출 스택에 `setTimeout(run, 5000)`이 쌓이고, 이 함수는 비동기 함수이기 때문에 **백그라운드**에 '5초뒤에 run함수를 실행'을 넣어두고 호출 스택에서 빠져나간다.
3. 더 이상 호출 스택에 들어와 실행할 것이 없으므로, `Anonymous`도 호출 스택에서 빠져나간다.
4. 호출 스택이 비었으면 그제서야 백그라운드에 있는 `run함수`는 5초뒤에 테스크 큐로 넘어간다.
5. 호출 스택이 비어있는 것을 확인하면 테스크 큐에 있는 `run함수`는 호출 스택으로 넘어간다.
6. 호출 스택에 `console.log("run run")`이 쌓이고, 이 함수가 실행되면서 콘솔창에 'run run'이라고 뜨고 호출 스택에서 빠져나간다.
7. 호출 스택에 `setTimeout(익명함수, 0)`이 쌓이고, 이 함수는 비동기 함수이기 때문에 백그라운드에 '0초뒤에 익명함수를 실행'을 넣어두고 호출 스택에서 빠져나간다.
8. 호출 스택에 `new Promise()`와 `resolve("hi")`가 차례대로 쌓이고 실행한 후 호출 스택에서 빠져나가고, `then console.log("hi")`는 백그라운드에 넣어둔다.
9. 호출 스택에 `oneMore()`와 `console.log("one More")`가 쌓이고, 차례대로 실행하면서 콘솔창에 'one More'을 출력하고 빠져나간다.
10. 더 이상 호출 스택에 들어와 실행할 것이 없으므로, `run`도 호출 스택에서 빠져나간다.
11. 백그라운드에 있는 작업들을 각각 처리하고 테스크 큐로 넘어간다.
12. 테스크 큐에 있는 작업들 중에 우선순위가 높은 작업들이 먼저 호출 스택으로 넘어가서 실행하고 호출 스택을 빠져나간다. 즉, `console.log("hi")`가 먼저 실행되고, 나중에 `console.log("wow")`가 실행된다.